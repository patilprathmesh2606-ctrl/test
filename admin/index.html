<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DigitalMenuPro - Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        .sidebar {
            transition: all 0.3s ease;
        }
        
        .sidebar.collapsed {
            width: 80px;
        }
        
        .sidebar.collapsed .sidebar-text {
            display: none;
        }
        
        .sidebar.collapsed .logo-text {
            display: none;
        }
        
        .stat-card {
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-active {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .status-suspended {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .payment-status-completed {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .payment-status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .payment-status-failed {
            background-color: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body class="bg-gray-50">

<!-- Loading Screen -->
<div id="loadingScreen" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 text-center">
        <div class="w-16 h-16 mx-auto mb-4 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
        <p class="text-gray-600">Loading dashboard...</p>
    </div>
</div>

<!-- Login Modal -->
<div id="loginModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 w-full max-w-md">
        <div class="text-center mb-8">
            <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-blue-600 to-purple-600 rounded-full flex items-center justify-center">
                <i class="fas fa-shield-alt text-white text-2xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800">Dashboard Login</h3>
            <p class="text-gray-600 mt-2">Access your management panel</p>
        </div>
        
        <div class="space-y-4">
            <input type="email" id="loginEmail" placeholder="Email Address" 
                   class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <input type="password" id="loginPassword" placeholder="Password" 
                   class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <button onclick="handleLogin()" class="w-full px-4 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg font-medium hover:from-blue-700 hover:to-purple-700">
                Login
            </button>
            
            <p class="text-sm text-gray-500 text-center mt-4">
                <i class="fas fa-info-circle mr-1"></i>
                Super Admin: admin@royalkitchen.com
            </p>
        </div>
    </div>
</div>

<!-- SUPER ADMIN DASHBOARD -->
<div id="adminDashboard" class="hidden flex min-h-screen">
    <!-- Admin Sidebar -->
    <div id="adminSidebar" class="sidebar bg-gradient-to-b from-gray-900 to-gray-800 text-white w-64 flex flex-col">
        <div class="p-6 border-b border-gray-700">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                    <i class="fas fa-shield-alt text-xl"></i>
                </div>
                <div class="ml-3 logo-text">
                    <h1 class="text-xl font-bold">Super Admin</h1>
                    <p class="text-xs text-gray-400">DigitalMenuPro</p>
                </div>
            </div>
        </div>
        
        <nav class="flex-1 p-4">
            <ul class="space-y-2">
                <li>
                    <a href="#" onclick="showAdminView('dashboard')" class="flex items-center p-3 rounded-lg hover:bg-gray-700 bg-gray-700">
                        <i class="fas fa-tachometer-alt w-6"></i>
                        <span class="ml-3 sidebar-text">Dashboard</span>
                    </a>
                </li>
                <li>
                    <a href="#" onclick="showAdminView('restaurants')" class="flex items-center p-3 rounded-lg hover:bg-gray-700">
                        <i class="fas fa-utensils w-6"></i>
                        <span class="ml-3 sidebar-text">Restaurants</span>
                    </a>
                </li>
                <li>
                    <a href="#" onclick="showAdminView('subscriptions')" class="flex items-center p-3 rounded-lg hover:bg-gray-700">
                        <i class="fas fa-credit-card w-6"></i>
                        <span class="ml-3 sidebar-text">Subscriptions</span>
                    </a>
                </li>
                <li>
                    <a href="#" onclick="showAdminView('payments')" class="flex items-center p-3 rounded-lg hover:bg-gray-700">
                        <i class="fas fa-rupee-sign w-6"></i>
                        <span class="ml-3 sidebar-text">Payments</span>
                    </a>
                </li>
                <li>
                    <a href="#" onclick="showAdminView('users')" class="flex items-center p-3 rounded-lg hover:bg-gray-700">
                        <i class="fas fa-users w-6"></i>
                        <span class="ml-3 sidebar-text">All Users</span>
                    </a>
                </li>
            </ul>
            
            <div class="mt-8 p-4 border-t border-gray-700">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="ml-3 sidebar-text">
                        <p class="font-medium" id="adminName">Super Admin</p>
                        <p class="text-xs text-gray-400" id="adminEmail">admin@royalkitchen.com</p>
                    </div>
                </div>
            </div>
        </nav>
        
        <div class="p-4 border-t border-gray-700">
            <button onclick="handleLogout()" class="flex items-center justify-center w-full p-2 rounded-lg hover:bg-gray-700">
                <i class="fas fa-sign-out-alt"></i>
                <span class="ml-3 sidebar-text">Logout</span>
            </button>
        </div>
    </div>
    
    <!-- Admin Main Content -->
    <div class="flex-1">
        <header class="bg-white shadow-sm border-b px-6 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-bold text-gray-800" id="adminViewTitle">Super Admin Dashboard</h2>
                    <p class="text-sm text-gray-600">Manage all restaurants and system</p>
                </div>
            </div>
        </header>
        
        <main class="p-6">
            <!-- Admin Dashboard View -->
            <div id="adminViewDashboard" class="admin-view">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="stat-card bg-white rounded-xl shadow-lg p-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-gray-600 text-sm">Total Restaurants</p>
                                <p class="text-3xl font-bold" id="adminTotalRestaurants">0</p>
                            </div>
                            <i class="fas fa-utensils text-4xl text-blue-500"></i>
                        </div>
                    </div>
                    
                    <div class="stat-card bg-white rounded-xl shadow-lg p-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-gray-600 text-sm">Active Subscriptions</p>
                                <p class="text-3xl font-bold" id="adminActiveSubscriptions">0</p>
                            </div>
                            <i class="fas fa-credit-card text-4xl text-green-500"></i>
                        </div>
                    </div>
                    
                    <div class="stat-card bg-white rounded-xl shadow-lg p-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-gray-600 text-sm">Monthly Revenue</p>
                                <p class="text-3xl font-bold" id="adminMonthlyRevenue">â‚¹0</p>
                            </div>
                            <i class="fas fa-rupee-sign text-4xl text-purple-500"></i>
                        </div>
                    </div>
                    
                    <div class="stat-card bg-white rounded-xl shadow-lg p-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-gray-600 text-sm">Total Users</p>
                                <p class="text-3xl font-bold" id="adminTotalUsers">0</p>
                            </div>
                            <i class="fas fa-users text-4xl text-yellow-500"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Activities -->
                <div class="bg-white rounded-xl shadow-lg p-6 mt-6">
                    <h3 class="text-lg font-bold mb-4">Recent Activities</h3>
                    <div id="adminActivitiesList" class="space-y-4">
                        <!-- Activities will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Admin Restaurants View -->
            <div id="adminViewRestaurants" class="admin-view hidden">
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="p-6">
                        <h3 class="text-lg font-bold mb-4">All Restaurants</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead>
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Restaurant</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Owner</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Slug</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="adminRestaurantsTable" class="divide-y divide-gray-200">
                                    <!-- Restaurants will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Other admin views... -->
            <div id="adminViewSubscriptions" class="admin-view hidden">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-bold">Subscriptions Management</h3>
                    <p class="text-gray-600 mt-2">Manage all subscription plans</p>
                </div>
            </div>
            
            <div id="adminViewPayments" class="admin-view hidden">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-bold">Payments Management</h3>
                    <p class="text-gray-600 mt-2">View and verify all payments</p>
                </div>
            </div>
            
            <div id="adminViewUsers" class="admin-view hidden">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-bold">Users Management</h3>
                    <p class="text-gray-600 mt-2">Manage all staff users across restaurants</p>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- STAFF DASHBOARD -->
<div id="staffDashboard" class="hidden min-h-screen">
    <header class="bg-gradient-to-r from-red-700 to-amber-700 text-white py-4 shadow-xl sticky top-0 z-40">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <div class="flex items-center">
                <div class="w-10 h-10 mr-3 bg-white rounded-full flex items-center justify-center">
                    <i class="fas fa-utensils text-red-600 text-xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold" id="staffRestaurantName">Restaurant Dashboard</h1>
                    <p class="text-sm text-red-100"><span id="staffUserName"></span> â€¢ <span id="staffUserRole"></span></p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-sm">
                    <i class="fas fa-user-circle mr-1"></i>
                    <span id="staffUserEmail"></span>
                </div>
                <button onclick="handleLogout()" class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
        </div>
    </header>

    <nav class="bg-white shadow sticky top-16 z-30">
        <div class="container mx-auto px-4 py-3 flex gap-2 overflow-x-auto" id="staffNavMenu"></div>
    </nav>

    <main class="container mx-auto px-4 py-8">
        <!-- Staff Dashboard View -->
        <div id="staffViewDashboard" class="staff-view">
            <h2 class="text-2xl font-bold mb-6">Dashboard</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center">
                        <div><p class="text-gray-600 text-sm">Users</p><p class="text-3xl font-bold" id="statUsers">0</p></div>
                        <i class="fas fa-users text-4xl text-blue-500"></i>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center">
                        <div><p class="text-gray-600 text-sm">Dishes</p><p class="text-3xl font-bold" id="statDishes">0</p></div>
                        <i class="fas fa-utensils text-4xl text-green-500"></i>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center">
                        <div><p class="text-gray-600 text-sm">Orders</p><p class="text-3xl font-bold" id="statOrders">0</p></div>
                        <i class="fas fa-receipt text-4xl text-purple-500"></i>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center">
                        <div><p class="text-gray-600 text-sm">Revenue</p><p class="text-3xl font-bold" id="statRevenue">â‚¹0</p></div>
                        <i class="fas fa-rupee-sign text-4xl text-amber-500"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Staff Dishes View -->
        <div id="staffViewDishes" class="staff-view hidden">
            <div class="flex justify-between mb-6">
                <h2 class="text-2xl font-bold">Menu Management</h2>
                <button onclick="showModal('dish')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    <i class="fas fa-plus mr-2"></i>Add Dish
                </button>
            </div>
            <div id="dishesList" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
        </div>

        <!-- Staff Reservations View -->
        <div id="staffViewReservations" class="staff-view hidden">
            <div class="flex justify-between mb-6">
                <h2 class="text-2xl font-bold">Reservations</h2>
            </div>
            <div id="reservationsList" class="space-y-4"></div>
        </div>

        <!-- Staff Orders View -->
        <div id="staffViewOrders" class="staff-view hidden">
            <div class="flex justify-between mb-6">
                <h2 class="text-2xl font-bold">Orders</h2>
            </div>
            <div id="ordersList" class="space-y-4"></div>
        </div>
    </main>
</div>

<script>
// Configuration
const SUPABASE_URL = 'https://aazqyrkklajqscsdfgjl.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFhenF5cmtrbGFqcXNjc2RmZ2psIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NTg4MjUsImV4cCI6MjA4NDMzNDgyNX0.MCmhASRpt_N1gkK7BiVBzp4NT98aCWOWetgtUCoj7Go';
const SUPER_ADMIN_EMAIL = 'admin@royalkitchen.com';

// Initialize Supabase
let supabaseClient;
try {
    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    console.log('âœ“ Supabase initialized successfully');
} catch (error) {
    console.error('Supabase initialization error:', error);
}

// Global variables
let currentUser = null;
let currentRestaurant = null;
let restaurants = [];
let subscriptions = [];
let payments = [];
let users = [];
let dishes = [];
let orders = [];
let reservations = [];

// Initialize the system
async function init() {
    try {
        console.log('ðŸš€ Initializing system...');
        
        // Check if user is already logged in
        const { data: { user } } = await supabaseClient.auth.getUser();
        
        if (user) {
            console.log('âœ“ Found logged in user:', user.email);
            await handleSession(user);
        } else {
            console.log('âš  No user logged in');
            showLoginModal();
        }
        
    } catch (error) {
        console.error('âŒ Initialization error:', error);
        showLoginModal();
    } finally {
        hideLoadingScreen();
    }
}

function showLoginModal() {
    document.getElementById('loadingScreen').style.display = 'none';
    document.getElementById('loginModal').classList.remove('hidden');
}

function hideLoadingScreen() {
    document.getElementById('loadingScreen').style.display = 'none';
}

async function handleLogin() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    
    if (!email || !password) {
        alert('Please enter email and password');
        return;
    }
    
    try {
        console.log('ðŸ” Attempting login for:', email);
        
        const { data, error } = await supabaseClient.auth.signInWithPassword({
            email: email,
            password: password
        });
        
        if (error) throw error;
        
        console.log('âœ“ Login successful');
        await handleSession(data.user);
        
    } catch (error) {
        console.error('âŒ Login error:', error);
        alert('Login failed: ' + error.message);
    }
}

async function handleSession(user) {
    try {
        console.log('ðŸ‘¤ Processing session for:', user.email);
        
        // Check if super admin
        if (user.email.toLowerCase() === SUPER_ADMIN_EMAIL.toLowerCase()) {
            console.log('ðŸ›¡ï¸ Super admin detected');
            await setupSuperAdminDashboard(user);
        } else {
            console.log('ðŸ‘¨â€ðŸ’¼ Regular staff user detected');
            await setupStaffDashboard(user);
        }
        
        // Hide login modal
        document.getElementById('loginModal').classList.add('hidden');
        
    } catch (error) {
        console.error('âŒ Session handling error:', error);
        alert('Error loading dashboard: ' + error.message);
        await handleLogout();
    }
}

async function setupSuperAdminDashboard(user) {
    try {
        console.log('ðŸ“Š Setting up super admin dashboard...');
        
        currentUser = {
            email: user.email,
            name: 'Super Admin',
            role: 'super_admin'
        };
        
        // Load ALL data
        await loadAdminData();
        
        // Show admin dashboard
        document.getElementById('adminDashboard').classList.remove('hidden');
        document.getElementById('staffDashboard').classList.add('hidden');
        
        document.getElementById('adminName').textContent = 'Super Admin';
        document.getElementById('adminEmail').textContent = user.email;
        
        // Update stats
        updateAdminStats();
        
        console.log('âœ“ Super admin dashboard ready');
        
    } catch (error) {
        console.error('âŒ Error setting up admin dashboard:', error);
        throw error;
    }
}

async function setupStaffDashboard(user) {
    try {
        console.log('ðŸ‘¨â€ðŸ’¼ Setting up staff dashboard...');
        
        // Get staff user data
        const { data: staffUser, error: staffError } = await supabaseClient
            .from('staff_users')
            .select('*')
            .eq('email', user.email)
            .single();
        
        if (staffError || !staffUser) {
            throw new Error('Staff account not found. Please contact administrator.');
        }
        
        if (!staffUser.is_active) {
            throw new Error('This account is disabled. Please contact administrator.');
        }
        
        // Get restaurant data
        const { data: restaurant, error: restError } = await supabaseClient
            .from('restaurants')
            .select('*')
            .eq('id', staffUser.restaurant_id)
            .single();
        
        if (restError || !restaurant) {
            throw new Error('Restaurant not found. Please contact administrator.');
        }
        
        currentUser = staffUser;
        currentRestaurant = restaurant;
        
        // Load restaurant data
        await loadStaffData();
        
        // Show staff dashboard
        document.getElementById('staffDashboard').classList.remove('hidden');
        document.getElementById('adminDashboard').classList.add('hidden');
        
        document.getElementById('staffRestaurantName').textContent = restaurant.name;
        document.getElementById('staffUserName').textContent = staffUser.name;
        document.getElementById('staffUserRole').textContent = staffUser.role.toUpperCase();
        document.getElementById('staffUserEmail').textContent = staffUser.email;
        
        // Setup navigation based on permissions
        setupStaffNav();
        
        // Update stats
        updateStaffStats();
        
        console.log('âœ“ Staff dashboard ready for:', restaurant.name);
        
    } catch (error) {
        console.error('âŒ Error setting up staff dashboard:', error);
        throw error;
    }
}

async function loadAdminData() {
    try {
        console.log('ðŸ“Š Loading admin data...');
        
        // Load ALL restaurants
        const { data: restaurantsData, error: resError } = await supabaseClient
            .from('restaurants')
            .select('*')
            .order('created_at', { ascending: false });
        
        if (!resError) {
            restaurants = restaurantsData || [];
            console.log(`âœ“ Loaded ${restaurants.length} restaurants`);
        }
        
        // Load subscriptions
        const { data: subsData, error: subsError } = await supabaseClient
            .from('subscriptions')
            .select('*')
            .order('created_at', { ascending: false });
        
        if (!subsError) subscriptions = subsData || [];
        
        // Load payments
        const { data: paymentsData, error: payError } = await supabaseClient
            .from('payments')
            .select('*')
            .order('created_at', { ascending: false });
        
        if (!payError) payments = paymentsData || [];
        
        // Load all users
        const { data: usersData, error: usersError } = await supabaseClient
            .from('staff_users')
            .select('*')
            .order('created_at', { ascending: false });
        
        if (!usersError) users = usersData || [];
        
        console.log('âœ“ Admin data loaded');
        
    } catch (error) {
        console.error('âŒ Error loading admin data:', error);
    }
}

async function loadStaffData() {
    try {
        console.log('ðŸ“Š Loading staff data...');
        
        // Load dishes for this restaurant
        const { data: dishesData, error: dishesError } = await supabaseClient
            .from('dishes')
            .select('*')
            .eq('restaurant_id', currentRestaurant.id)
            .eq('is_active', true);
        
        if (!dishesError) dishes = dishesData || [];
        
        // Load orders
        const { data: ordersData, error: ordersError } = await supabaseClient
            .from('orders')
            .select('*')
            .eq('restaurant_id', currentRestaurant.id);
        
        if (!ordersError) orders = ordersData || [];
        
        // Load reservations
        const { data: reservationsData, error: resError } = await supabaseClient
            .from('reservations')
            .select('*')
            .eq('restaurant_id', currentRestaurant.id);
        
        if (!resError) reservations = reservationsData || [];
        
        // Load staff users for this restaurant
        const { data: usersData, error: usersError } = await supabaseClient
            .from('staff_users')
            .select('*')
            .eq('restaurant_id', currentRestaurant.id);
        
        if (!usersError) users = usersData || [];
        
        console.log('âœ“ Staff data loaded');
        
    } catch (error) {
        console.error('âŒ Error loading staff data:', error);
    }
}

function updateAdminStats() {
    document.getElementById('adminTotalRestaurants').textContent = restaurants.length;
    document.getElementById('adminActiveSubscriptions').textContent = subscriptions.filter(s => s.status === 'active').length;
    
    const monthlyRevenue = payments
        .filter(p => p.status === 'completed')
        .reduce((sum, p) => sum + (p.amount || 0), 0);
    document.getElementById('adminMonthlyRevenue').textContent = `â‚¹${monthlyRevenue}`;
    
    document.getElementById('adminTotalUsers').textContent = users.length;
    
    // Load restaurants table
    loadAdminRestaurantsTable();
    
    // Load activities
    loadAdminActivities();
}

function loadAdminRestaurantsTable() {
    let html = '';
    
    restaurants.slice(0, 10).forEach(restaurant => {
        html += `
            <tr>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="font-medium text-gray-900">${restaurant.name}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${restaurant.owner_email}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <code class="px-2 py-1 bg-gray-100 rounded">${restaurant.url_slug}</code>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="status-badge ${restaurant.status === 'active' ? 'status-active' : restaurant.status === 'pending' ? 'status-pending' : 'status-suspended'}">
                        ${restaurant.status.toUpperCase()}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${new Date(restaurant.created_at).toLocaleDateString()}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <button onclick="toggleRestaurantStatus('${restaurant.id}')" class="text-yellow-600 hover:text-yellow-900 mr-2">
                        <i class="fas fa-power-off"></i>
                    </button>
                    <button onclick="deleteRestaurant('${restaurant.id}')" class="text-red-600 hover:text-red-900">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    document.getElementById('adminRestaurantsTable').innerHTML = html || `
        <tr>
            <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                No restaurants found
            </td>
        </tr>
    `;
}

function loadAdminActivities() {
    let html = '';
    
    const recentRestaurants = restaurants.slice(0, 5);
    recentRestaurants.forEach(restaurant => {
        const date = new Date(restaurant.created_at).toLocaleDateString();
        
        html += `
            <div class="flex items-start">
                <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mr-3">
                    <i class="fas fa-utensils text-sm"></i>
                </div>
                <div class="flex-1">
                    <p class="font-medium">${restaurant.name}</p>
                    <p class="text-sm text-gray-600">New restaurant registered</p>
                    <p class="text-xs text-gray-500">${date} â€¢ Slug: ${restaurant.url_slug}</p>
                </div>
            </div>
        `;
    });
    
    document.getElementById('adminActivitiesList').innerHTML = html || '<p class="text-gray-500 text-center py-4">No recent activities</p>';
}

function updateStaffStats() {
    document.getElementById('statUsers').textContent = users.length;
    document.getElementById('statDishes').textContent = dishes.length;
    document.getElementById('statOrders').textContent = orders.length;
    
    const totalRevenue = orders.reduce((sum, o) => sum + (o.total || 0), 0);
    document.getElementById('statRevenue').textContent = `â‚¹${totalRevenue}`;
}

function setupStaffNav() {
    const permissions = currentUser.permissions || {};
    let nav = '<button onclick="showStaffView(\'dashboard\')" class="px-4 py-2 rounded-lg hover:bg-gray-100 bg-gray-100"><i class="fas fa-home mr-2"></i>Dashboard</button>';
    
    if (permissions.addDish || permissions.editDish || permissions.deleteDish) {
        nav += '<button onclick="showStaffView(\'dishes\')" class="px-4 py-2 rounded-lg hover:bg-gray-100"><i class="fas fa-utensils mr-2"></i>Dishes</button>';
    }
    
    if (permissions.reserveTable) {
        nav += '<button onclick="showStaffView(\'reservations\')" class="px-4 py-2 rounded-lg hover:bg-gray-100"><i class="fas fa-calendar mr-2"></i>Reservations</button>';
    }
    
    if (permissions.viewTableOrders) {
        nav += '<button onclick="showStaffView(\'orders\')" class="px-4 py-2 rounded-lg hover:bg-gray-100"><i class="fas fa-clipboard-list mr-2"></i>Orders</button>';
    }
    
    document.getElementById('staffNavMenu').innerHTML = nav;
}

function showAdminView(viewName) {
    document.querySelectorAll('.admin-view').forEach(view => {
        view.classList.add('hidden');
    });
    
    document.querySelectorAll('#adminSidebar a').forEach(link => {
        link.classList.remove('bg-gray-700');
    });
    
    const viewElement = document.getElementById(`adminView${viewName.charAt(0).toUpperCase() + viewName.slice(1)}`);
    if (viewElement) {
        viewElement.classList.remove('hidden');
    }
    
    const activeLink = document.querySelector(`#adminSidebar a[onclick="showAdminView('${viewName}')"]`);
    if (activeLink) {
        activeLink.classList.add('bg-gray-700');
    }
}

function showStaffView(viewName) {
    document.querySelectorAll('.staff-view').forEach(view => {
        view.classList.add('hidden');
    });
    
    document.querySelectorAll('#staffNavMenu button').forEach(btn => {
        btn.classList.remove('bg-gray-100');
    });
    
    const viewElement = document.getElementById(`staffView${viewName.charAt(0).toUpperCase() + viewName.slice(1)}`);
    if (viewElement) {
        viewElement.classList.remove('hidden');
    }
    
    const activeBtn = document.querySelector(`#staffNavMenu button[onclick="showStaffView('${viewName}')"]`);
    if (activeBtn) {
        activeBtn.classList.add('bg-gray-100');
    }
    
    // Load view data
    if (viewName === 'dishes') {
        renderDishes();
    } else if (viewName === 'reservations') {
        renderReservations();
    } else if (viewName === 'orders') {
        renderOrders();
    }
}

function renderDishes() {
    let html = '';
    
    dishes.forEach(dish => {
        html += `
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <img src="${dish.image_url || 'https://via.placeholder.com/300x200?text=No+Image'}" alt="${dish.name}" class="w-full h-48 object-cover">
                <div class="p-4">
                    <h3 class="font-bold text-lg">${dish.name}</h3>
                    <p class="text-gray-600 text-sm">${dish.description || ''}</p>
                    <div class="flex justify-between mt-4">
                        <span class="font-bold text-lg">â‚¹${dish.price}</span>
                        <span class="px-3 py-1 bg-gray-100 rounded-full text-sm">${dish.category}</span>
                    </div>
                </div>
            </div>
        `;
    });
    
    document.getElementById('dishesList').innerHTML = html || '<p class="text-gray-500 text-center py-8 col-span-3">No dishes available.</p>';
}

function renderReservations() {
    let html = '';
    
    reservations.forEach(res => {
        html += `
            <div class="bg-white p-4 rounded-xl shadow">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="font-bold">${res.customer_name}</h3>
                        <p class="text-gray-600 text-sm">Table ${res.table_number} â€¢ ${res.guest_count} guests</p>
                        <p class="text-gray-600 text-sm">${res.date} at ${res.time}</p>
                    </div>
                    <span class="px-3 py-1 ${res.status === 'confirmed' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'} rounded">
                        ${res.status}
                    </span>
                </div>
            </div>
        `;
    });
    
    document.getElementById('reservationsList').innerHTML = html || '<p class="text-gray-500 text-center py-8">No reservations found.</p>';
}

function renderOrders() {
    let html = '';
    
    orders.forEach(order => {
        html += `
            <div class="bg-white p-4 rounded-xl shadow">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="font-bold">Table ${order.table_number}</h3>
                        <p class="text-gray-600 text-sm">${order.customer_name || 'Guest'}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-lg">â‚¹${order.total || 0}</p>
                        <span class="px-3 py-1 ${order.status === 'completed' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'} rounded text-sm">
                            ${order.status}
                        </span>
                    </div>
                </div>
            </div>
        `;
    });
    
    document.getElementById('ordersList').innerHTML = html || '<p class="text-gray-500 text-center py-8">No orders found</p>';
}

async function toggleRestaurantStatus(restaurantId) {
    const restaurant = restaurants.find(r => r.id === restaurantId);
    if (!restaurant) return;
    
    const newStatus = restaurant.status === 'active' ? 'suspended' : 'active';
    
    if (!confirm(`${newStatus === 'suspended' ? 'Suspend' : 'Activate'} this restaurant?`)) {
        return;
    }
    
    try {
        const { error } = await supabaseClient
            .from('restaurants')
            .update({ status: newStatus })
            .eq('id', restaurantId);
        
        if (error) throw error;
        
        restaurant.status = newStatus;
        loadAdminRestaurantsTable();
        alert(`Restaurant ${newStatus}!`);
        
    } catch (error) {
        console.error('Error updating status:', error);
        alert('Error: ' + error.message);
    }
}

async function deleteRestaurant(restaurantId) {
    if (!confirm('WARNING: Delete this restaurant permanently?')) return;
    
    try {
        const { error } = await supabaseClient
            .from('restaurants')
            .delete()
            .eq('id', restaurantId);
        
        if (error) throw error;
        
        restaurants = restaurants.filter(r => r.id !== restaurantId);
        loadAdminRestaurantsTable();
        updateAdminStats();
        alert('Restaurant deleted!');
        
    } catch (error) {
        console.error('Error deleting restaurant:', error);
        alert('Error: ' + error.message);
    }
}

function showModal(type) {
    alert('Modal for ' + type + ' - Coming soon!');
}

async function handleLogout() {
    try {
        await supabaseClient.auth.signOut();
        currentUser = null;
        currentRestaurant = null;
        
        document.getElementById('adminDashboard').classList.add('hidden');
        document.getElementById('staffDashboard').classList.add('hidden');
        
        showLoginModal();
        
    } catch (error) {
        console.error('Logout error:', error);
    }
}

// Initialize on page load
window.addEventListener('load', init);
</script>
</body>
</html>
