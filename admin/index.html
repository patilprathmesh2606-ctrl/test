<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - DigitalMenuPro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .sidebar {
            transition: all 0.3s ease;
        }
        
        .sidebar.collapsed {
            width: 80px;
        }
        
        .sidebar.collapsed .sidebar-text {
            display: none;
        }
        
        .sidebar.collapsed .logo-text {
            display: none;
        }
        
        .main-content {
            transition: all 0.3s ease;
        }
        
        .stat-card {
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .restaurant-row:hover {
            background-color: #f8fafc;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-active {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .status-suspended {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .hidden {
            display: none !important;
        }
        
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px dashed #d1d5db;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .aspect-square {
            aspect-ratio: 1 / 1;
        }
        
        .image-grid-item {
            transition: all 0.2s ease;
        }
        
        .image-grid-item:hover {
            transform: scale(1.05);
        }
        
        .image-grid-item.selected {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .image-thumbnail {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .image-thumbnail.selected {
            border: 3px solid #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        
        .default-image {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .default-image.selected {
            border: 3px solid #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="flex min-h-screen">
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar bg-gradient-to-b from-gray-900 to-gray-800 text-white w-64 flex flex-col">
            <!-- Logo -->
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-shield-alt text-xl"></i>
                    </div>
                    <div class="ml-3 logo-text">
                        <h1 class="text-xl font-bold" id="dashboardTitle">Admin Panel</h1>
                        <p class="text-xs text-gray-400" id="dashboardSubtitle">DigitalMenuPro</p>
                    </div>
                </div>
            </div>
            
            <!-- Navigation -->
            <nav class="flex-1 p-4">
                <ul class="space-y-2" id="sidebarNav">
                    <li>
                        <a href="#" onclick="showView('dashboard')" class="flex items-center p-3 rounded-lg hover:bg-gray-700 active-nav">
                            <i class="fas fa-tachometer-alt w-6"></i>
                            <span class="ml-3 sidebar-text">Dashboard</span>
                        </a>
                    </li>
                    <li class="admin-only">
                        <a href="#" onclick="showView('restaurants')" class="flex items-center p-3 rounded-lg hover:bg-gray-700">
                            <i class="fas fa-utensils w-6"></i>
                            <span class="ml-3 sidebar-text">Restaurants</span>
                        </a>
                    </li>
                    <li class="admin-only">
                        <a href="#" onclick="showView('subscriptions')" class="flex items-center p-3 rounded-lg hover:bg-gray-700">
                            <i class="fas fa-credit-card w-6"></i>
                            <span class="ml-3 sidebar-text">Subscriptions</span>
                        </a>
                    </li>
                    <li class="admin-only">
                        <a href="#" onclick="showView('payments')" class="flex items-center p-3 rounded-lg hover:bg-gray-700">
                            <i class="fas fa-rupee-sign w-6"></i>
                            <span class="ml-3 sidebar-text">Payments</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="showView('users')" class="flex items-center p-3 rounded-lg hover:bg-gray-700">
                            <i class="fas fa-users w-6"></i>
                            <span class="ml-3 sidebar-text" id="usersMenuText">All Users</span>
                        </a>
                    </li>
                    <li class="admin-only">
                        <a href="#" onclick="showView('staff_permissions')" class="flex items-center p-3 rounded-lg hover:bg-gray-700">
                            <i class="fas fa-user-shield w-6"></i>
                            <span class="ml-3 sidebar-text">Staff Permissions</span>
                        </a>
                    </li>
                    <li class="admin-only">
                        <a href="#" onclick="showView('plans')" class="flex items-center p-3 rounded-lg hover:bg-gray-700">
                            <i class="fas fa-cubes w-6"></i>
                            <span class="ml-3 sidebar-text">Plan Management</span>
                        </a>
                    </li>
                    <li class="admin-only">
                        <a href="#" onclick="showView('settings')" class="flex items-center p-3 rounded-lg hover:bg-gray-700">
                            <i class="fas fa-cog w-6"></i>
                            <span class="ml-3 sidebar-text">System Settings</span>
                        </a>
                    </li>
                    <li class="admin-only">
                        <a href="#" onclick="showView('terms')" class="flex items-center p-3 rounded-lg hover:bg-gray-700">
                            <i class="fas fa-file-contract w-6"></i>
                            <span class="ml-3 sidebar-text">Terms & Policies</span>
                        </a>
                    </li>
                </ul>
                
                <!-- User Profile -->
                <div class="mt-8 p-4 border-t border-gray-700">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-user-shield"></i>
                        </div>
                        <div class="ml-3 sidebar-text">
                            <p class="font-medium" id="adminName">Loading...</p>
                            <p class="text-xs text-gray-400" id="adminEmail">Loading...</p>
                        </div>
                    </div>
                </div>
            </nav>
            
            <!-- Toggle Sidebar -->
            <div class="p-4 border-t border-gray-700">
                <button onclick="toggleSidebar()" class="flex items-center justify-center w-full p-2 rounded-lg hover:bg-gray-700">
                    <i class="fas fa-chevron-left"></i>
                    <span class="ml-3 sidebar-text">Collapse Sidebar</span>
                </button>
            </div>
        </div>
        
        <!-- Main Content -->
        <div id="mainContent" class="main-content flex-1">
            <!-- Top Bar -->
            <header class="bg-white shadow-sm border-b px-6 py-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800" id="viewTitle">Admin Dashboard</h2>
                        <p class="text-sm text-gray-600" id="viewSubtitle">System Overview & Analytics</p>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <!-- Notifications -->
                        <div class="relative">
                            <button onclick="toggleNotifications()" class="p-2 rounded-full hover:bg-gray-100 relative">
                                <i class="fas fa-bell text-gray-600"></i>
                                <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
                            </button>
                            <div id="notificationsPanel" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl z-50 border">
                                <div class="p-4 border-b">
                                    <h3 class="font-bold">Notifications</h3>
                                </div>
                                <div class="max-h-96 overflow-y-auto">
                                    <div id="notificationsList" class="p-4 space-y-3">
                                        <!-- Notifications will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Search -->
                        <div class="relative">
                            <input type="text" id="globalSearch" placeholder="Search..." 
                                   class="pl-10 pr-4 py-2 border rounded-lg w-64 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                        
                        <!-- Logout -->
                        <button onclick="adminLogout()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                            <i class="fas fa-sign-out-alt mr-2"></i>Logout
                        </button>
                    </div>
                </div>
            </header>
            
            <!-- Content Area -->
            <main class="p-6">
                <!-- Dashboard View -->
                <div id="viewDashboard" class="view space-y-6">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="stat-card bg-white rounded-xl shadow-lg p-6">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-gray-600 text-sm" id="stat1Title">Total Restaurants</p>
                                    <p class="text-3xl font-bold" id="totalRestaurants">0</p>
                                </div>
                                <i class="fas fa-utensils text-4xl text-blue-500"></i>
                            </div>
                            <div class="mt-4">
                                <div class="flex text-sm">
                                    <span class="text-green-600"><i class="fas fa-arrow-up mr-1"></i> 12%</span>
                                    <span class="text-gray-500 ml-2">from last month</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-card bg-white rounded-xl shadow-lg p-6">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-gray-600 text-sm" id="stat2Title">Active Subscriptions</p>
                                    <p class="text-3xl font-bold" id="activeSubscriptions">0</p>
                                </div>
                                <i class="fas fa-credit-card text-4xl text-green-500"></i>
                            </div>
                            <div class="mt-4">
                                <div class="flex text-sm">
                                    <span class="text-green-600"><i class="fas fa-arrow-up mr-1"></i> 8%</span>
                                    <span class="text-gray-500 ml-2">from last month</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-card bg-white rounded-xl shadow-lg p-6">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-gray-600 text-sm" id="stat3Title">Monthly Revenue</p>
                                    <p class="text-3xl font-bold" id="monthlyRevenue">₹0</p>
                                </div>
                                <i class="fas fa-rupee-sign text-4xl text-purple-500"></i>
                            </div>
                            <div class="mt-4">
                                <div class="flex text-sm">
                                    <span class="text-green-600"><i class="fas fa-arrow-up mr-1"></i> 15%</span>
                                    <span class="text-gray-500 ml-2">from last month</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-card bg-white rounded-xl shadow-lg p-6">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-gray-600 text-sm" id="stat4Title">Pending Payments</p>
                                    <p class="text-3xl font-bold" id="pendingPayments">0</p>
                                </div>
                                <i class="fas fa-clock text-4xl text-yellow-500"></i>
                            </div>
                            <div class="mt-4">
                                <div class="flex text-sm">
                                    <span class="text-red-600"><i class="fas fa-arrow-down mr-1"></i> 3%</span>
                                    <span class="text-gray-500 ml-2">from last month</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Staff Actions Section (Visible only to staff) -->
                    <div id="staffActionsSection" class="hidden">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-bold mb-4">Quick Actions</h3>
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                                <button onclick="showAddDishModal()" class="staff-action p-3 bg-green-100 text-green-800 rounded-lg hover:bg-green-200 flex flex-col items-center" data-permission="addDish">
                                    <i class="fas fa-plus mb-1"></i>
                                    <span class="text-xs">Add Dish</span>
                                </button>
                                
                                <button onclick="showEditDishModal()" class="staff-action p-3 bg-blue-100 text-blue-800 rounded-lg hover:bg-blue-200 flex flex-col items-center" data-permission="editDish">
                                    <i class="fas fa-edit mb-1"></i>
                                    <span class="text-xs">Edit Dish</span>
                                </button>
                                
                                <button onclick="showDeleteDishModal()" class="staff-action p-3 bg-red-100 text-red-800 rounded-lg hover:bg-red-200 flex flex-col items-center" data-permission="deleteDish">
                                    <i class="fas fa-trash mb-1"></i>
                                    <span class="text-xs">Delete Dish</span>
                                </button>
                                
                                <button onclick="showRevenueReport()" class="staff-action p-3 bg-purple-100 text-purple-800 rounded-lg hover:bg-purple-200 flex flex-col items-center" data-permission="viewRevenue">
                                    <i class="fas fa-rupee-sign mb-1"></i>
                                    <span class="text-xs">View Revenue</span>
                                </button>
                                
                                <button onclick="showReserveTableModal()" class="staff-action p-3 bg-yellow-100 text-yellow-800 rounded-lg hover:bg-yellow-200 flex flex-col items-center" data-permission="reserveTable">
                                    <i class="fas fa-chair mb-1"></i>
                                    <span class="text-xs">Reserve Table</span>
                                </button>
                                
                                <button onclick="showOrdersModal()" class="staff-action p-3 bg-indigo-100 text-indigo-800 rounded-lg hover:bg-indigo-200 flex flex-col items-center" data-permission="viewTableOrders">
                                    <i class="fas fa-list-alt mb-1"></i>
                                    <span class="text-xs">View Orders</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-bold mb-4">Revenue Trend</h3>
                            <div class="h-80">
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-bold mb-4">Plan Distribution</h3>
                            <div class="h-80">
                                <canvas id="planChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Restaurants View -->
                <div id="viewRestaurants" class="view hidden">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold" id="restaurantsViewTitle">Restaurant Management</h2>
                            <p class="text-gray-600" id="restaurantsViewSubtitle">Manage all registered restaurants</p>
                        </div>
                        <div class="flex space-x-3">
                            <input type="text" id="restaurantSearch" placeholder="Search restaurants..." 
                                   class="px-4 py-2 border rounded-lg w-64" oninput="filterRestaurants()">
                            <button onclick="exportRestaurants()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 admin-only">
                                <i class="fas fa-download mr-2"></i>Export
                            </button>
                            <button onclick="showAddDishModal()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 staff-only hidden">
                                <i class="fas fa-plus mr-2"></i>Add Dish
                            </button>
                        </div>
                    </div>
                    
                    <!-- Restaurants/Menu Table -->
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr id="restaurantsTableHeader">
                                        <!-- Table headers will be set dynamically -->
                                    </tr>
                                </thead>
                                <tbody id="restaurantsTable" class="bg-white divide-y divide-gray-200">
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Admin Login Modal -->
    <div id="adminLoginModal" class="modal-overlay fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-blue-600 to-purple-600 rounded-full flex items-center justify-center">
                    <i class="fas fa-shield-alt text-white text-2xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-800">Admin Login</h3>
                <p class="text-gray-600 mt-2">DigitalMenuPro Control Panel</p>
            </div>
            
            <div class="space-y-4">
                <input type="email" id="adminEmailInput" placeholder="Admin Email" 
                       class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <input type="password" id="adminPassword" placeholder="Password" 
                       class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <button onclick="handleAdminLogin()" class="w-full px-4 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg font-medium hover:from-blue-700 hover:to-purple-700">
                    Login as Admin
                </button>
            </div>
        </div>
    </div>

    <!-- Add Dish Modal -->
    <div id="addDishModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Add New Dish</h3>
                    <button onclick="closeAddDishModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="addDishForm" onsubmit="event.preventDefault(); saveNewDish();">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Dish Name *</label>
                            <input type="text" id="dishName" required 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                            <textarea id="dishDescription" rows="3" 
                                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Category *</label>
                                <select id="dishCategory" required 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Select Category</option>
                                    <option value="Drinks">Drinks</option>
                                    <option value="Chinese">Chinese</option>
                                    <option value="Desserts">Desserts</option>
                                    <option value="Fast Food">Fast Food</option>
                                    <option value="Specials">Specials</option>
                                    <option value="Soups">Soups</option>
                                    <option value="Salads">Salads</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Price (₹) *</label>
                                <input type="number" id="dishPrice" min="0" step="0.01" required 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Preparation Time (minutes)</label>
                                <input type="number" id="dishPrepTime" min="0" 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Availability</label>
                                <select id="dishAvailability" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="true">Available</option>
                                    <option value="false">Not Available</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tags (comma separated)</label>
                            <input type="text" id="dishTags" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="e.g., spicy, vegan, gluten-free">
                        </div>
                        
                        <!-- Image Selection Section -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Select Dish Image</label>
                            
                            <!-- Search Bar -->
                            <div class="flex items-center gap-2 mb-3">
                                <input type="text" id="addImageSearch" placeholder="Search images..." 
                                       oninput="searchAddImages()" 
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <button type="button" onclick="refreshAddImageGallery()" class="px-3 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            
                            <div class="text-sm text-gray-500 mb-3">
                                <i class="fas fa-info-circle mr-1"></i>
                                Select an image from your gallery
                            </div>
                            
                            <!-- Current Image Preview -->
                            <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Selected Image:</label>
                                <div class="flex items-center justify-center">
                                    <img id="addSelectedImagePreview" src="https://via.placeholder.com/300x200?text=No+Image" 
                                         class="w-full max-h-48 object-cover rounded-lg border-2 border-blue-500">
                                </div>
                                <input type="hidden" id="addSelectedImageUrl">
                                <div class="mt-2 text-center">
                                    <button type="button" onclick="clearAddSelectedImage()" class="text-sm text-red-600 hover:text-red-800">
                                        <i class="fas fa-times mr-1"></i>Remove Image
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Image Gallery -->
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-sm font-medium text-gray-700">Available Images:</label>
                                    <span id="addImageCount" class="text-sm text-gray-500">0 images</span>
                                </div>
                                <div id="addImageGallery" class="grid grid-cols-3 gap-2 max-h-64 overflow-y-auto p-2 bg-gray-50 rounded-lg border border-gray-300">
                                    <div class="col-span-3 text-center py-8">
                                        <div class="loading inline-block"></div>
                                        <p class="text-gray-600 mt-2">Loading images...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4 border-t">
                            <button type="button" onclick="closeAddDishModal()" 
                                    class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                Cancel
                            </button>
                            <button type="submit" id="saveDishBtn" 
                                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center">
                                <span>Save Dish</span>
                                <div id="saveDishLoading" class="loading ml-2 hidden"></div>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Dish Modal -->
    <div id="editDishModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Edit Dish</h3>
                    <button onclick="closeEditDishModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="editDishForm" onsubmit="event.preventDefault(); updateDish();">
                    <input type="hidden" id="editDishId">
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Dish Name *</label>
                            <input type="text" id="editDishName" required 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                            <textarea id="editDishDescription" rows="3" 
                                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Category *</label>
                                <select id="editDishCategory" required 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Select Category</option>
                                    <option value="Drinks">Drinks</option>
                                    <option value="Chinese">Chinese</option>
                                    <option value="Desserts">Desserts</option>
                                    <option value="Fast Food">Fast Food</option>
                                    <option value="Specials">Specials</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Price (₹) *</label>
                                <input type="number" id="editDishPrice" min="0" step="0.01" required 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Preparation Time (minutes)</label>
                                <input type="number" id="editDishPrepTime" min="0" 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Availability</label>
                                <select id="editDishAvailability" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="true">Available</option>
                                    <option value="false">Not Available</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tags (comma separated)</label>
                            <input type="text" id="editDishTags" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <!-- Image Selection Section -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Select Dish Image</label>
                            
                            <!-- Search Bar -->
                            <div class="flex items-center gap-2 mb-3">
                                <input type="text" id="editImageSearch" placeholder="Search images..." 
                                       oninput="searchEditImages()" 
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <button type="button" onclick="refreshEditImageGallery()" class="px-3 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            
                            <div class="text-sm text-gray-500 mb-3">
                                <i class="fas fa-info-circle mr-1"></i>
                                Select an image from your gallery
                            </div>
                            
                            <!-- Current Image Preview -->
                            <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Selected Image:</label>
                                <div class="flex items-center justify-center">
                                    <img id="editSelectedImagePreview" src="https://via.placeholder.com/300x200?text=No+Image" 
                                         class="w-full max-h-48 object-cover rounded-lg border-2 border-blue-500">
                                </div>
                                <input type="hidden" id="editSelectedImageUrl">
                                <div class="mt-2 text-center">
                                    <button type="button" onclick="clearEditSelectedImage()" class="text-sm text-red-600 hover:text-red-800">
                                        <i class="fas fa-times mr-1"></i>Remove Image
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Image Gallery -->
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-sm font-medium text-gray-700">Available Images:</label>
                                    <span id="editImageCount" class="text-sm text-gray-500">0 images</span>
                                </div>
                                <div id="editImageGallery" class="grid grid-cols-3 gap-2 max-h-64 overflow-y-auto p-2 bg-gray-50 rounded-lg border border-gray-300">
                                    <div class="col-span-3 text-center py-8">
                                        <div class="loading inline-block"></div>
                                        <p class="text-gray-600 mt-2">Loading images...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4 border-t">
                            <button type="button" onclick="closeEditDishModal()" 
                                    class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                Cancel
                            </button>
                            <button type="submit" id="updateDishBtn" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                                <span>Update Dish</span>
                                <div id="updateDishLoading" class="loading ml-2 hidden"></div>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Dish Confirmation Modal -->
    <div id="deleteDishModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-xl w-full max-w-md">
            <div class="p-6">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Delete Dish</h3>
                    <p class="text-gray-600" id="deleteDishMessage">Are you sure you want to delete this dish?</p>
                </div>
                
                <input type="hidden" id="deleteDishId">
                
                <div class="flex justify-center space-x-3">
                    <button onclick="closeDeleteDishModal()" 
                            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Cancel
                    </button>
                    <button onclick="confirmDeleteDish()" 
                            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

<script>
// Configuration
const SUPABASE_URL = 'https://aazqyrkklajqscsdfgjl.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFhenF5cmtrbGFqcXNjc2RmZ2psIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NTg4MjUsImV4cCI6MjA4NDMzNDgyNX0.MCmhASRpt_N1gkK7BiVBzp4NT98aCWOWetgtUCoj7Go';

// Initialize Supabase
let supabaseClient;
try {
    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    console.log('✓ Supabase initialized successfully');
} catch (error) {
    console.error('Supabase initialization error:', error);
}

// Global variables
let currentUser = null;
let currentRestaurant = null;
let userRole = 'admin';
let isStaffMode = false;
let restaurants = [];
let dishes = [];
let availableImages = [];

// Initialize dashboard
async function initDashboard() {
    try {
        // Set today's date for date inputs
        const today = new Date().toISOString().split('T')[0];
        
        // Check if user is already logged in
        const { data: { user } } = await supabaseClient.auth.getUser();
        
        if (user) {
            const urlParams = new URLSearchParams(window.location.search);
            const restaurantSlug = urlParams.get('restaurant');
            const staffParam = urlParams.get('staff');
            
            if (restaurantSlug && staffParam === 'true') {
                isStaffMode = true;
                await handleStaffAccess(user, restaurantSlug);
            } else {
                await handleAdminAccess(user);
            }
        } else {
            document.getElementById('adminLoginModal').classList.remove('hidden');
        }
    } catch (error) {
        console.error('Dashboard initialization error:', error);
        document.getElementById('adminLoginModal').classList.remove('hidden');
    }
}

// Load images from Supabase Storage
async function loadDishImagesFromStorage() {
    try {
        const { data: files, error } = await supabaseClient.storage
            .from('dish-images')
            .list('', {
                limit: 100,
                offset: 0,
                sortBy: { column: 'name', order: 'asc' }
            });
        
        if (error) {
            console.error('Error loading images:', error);
            return [];
        }
        
        // Get public URLs for all images
        const imageUrls = files
            .filter(file => !file.id) // Filter out folders
            .map(file => {
                const { data: { publicUrl } } = supabaseClient.storage
                    .from('dish-images')
                    .getPublicUrl(file.name);
                return {
                    name: file.name,
                    url: publicUrl
                };
            });
        
        console.log(`Loaded ${imageUrls.length} images from storage`);
        return imageUrls;
        
    } catch (error) {
        console.error('Error loading images:', error);
        return [];
    }
}

// Render image grid
function renderImageGrid(images, containerId, selectedImageUrl = null) {
    const container = document.getElementById(containerId);
    const countId = containerId.replace('Gallery', 'Count');
    const countElement = document.getElementById(countId);
    
    if (!container) return;
    
    if (countElement) {
        countElement.textContent = `${images.length} images`;
    }
    
    if (!images || images.length === 0) {
        container.innerHTML = `
            <div class="col-span-3 text-center py-8 text-gray-500">
                <i class="fas fa-image text-3xl mb-2"></i>
                <p>No images found in storage</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    
    images.forEach((image, index) => {
        const isSelected = selectedImageUrl === image.url;
        const fileName = image.name.length > 15 ? image.name.substring(0, 12) + '...' : image.name;
        
        html += `
            <div class="relative group cursor-pointer" onclick="selectImageFromGallery('${image.url}', '${containerId}')">
                <img src="${image.url}" 
                     alt="${image.name}"
                     class="w-full h-20 object-cover rounded-lg border-2 ${isSelected ? 'border-blue-500' : 'border-gray-200'} hover:border-blue-400 transition-all"
                     loading="lazy">
                ${isSelected ? '<div class="absolute top-1 right-1 bg-blue-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs"><i class="fas fa-check"></i></div>' : ''}
                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all rounded-lg"></div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Select image from gallery
function selectImageFromGallery(imageUrl, containerId) {
    const modalType = containerId.includes('add') ? 'add' : 'edit';
    
    if (modalType === 'add') {
        document.getElementById('addSelectedImageUrl').value = imageUrl;
        document.getElementById('addSelectedImagePreview').src = imageUrl;
    } else {
        document.getElementById('editSelectedImageUrl').value = imageUrl;
        document.getElementById('editSelectedImagePreview').src = imageUrl;
    }
    
    // Re-render gallery to show selection
    const images = availableImages;
    renderImageGrid(images, containerId, imageUrl);
}

// Clear selected image for Add modal
function clearAddSelectedImage() {
    document.getElementById('addSelectedImageUrl').value = '';
    document.getElementById('addSelectedImagePreview').src = 'https://via.placeholder.com/300x200?text=No+Image';
    renderImageGrid(availableImages, 'addImageGallery', null);
}

// Clear selected image for Edit modal
function clearEditSelectedImage() {
    document.getElementById('editSelectedImageUrl').value = '';
    document.getElementById('editSelectedImagePreview').src = 'https://via.placeholder.com/300x200?text=No+Image';
    renderImageGrid(availableImages, 'editImageGallery', null);
}

// Search images in Add modal
function searchAddImages() {
    const searchTerm = document.getElementById('addImageSearch').value.toLowerCase();
    
    if (!searchTerm) {
        renderImageGrid(availableImages, 'addImageGallery', document.getElementById('addSelectedImageUrl').value);
        return;
    }
    
    const filteredImages = availableImages.filter(img => 
        img.name.toLowerCase().includes(searchTerm)
    );
    
    renderImageGrid(filteredImages, 'addImageGallery', document.getElementById('addSelectedImageUrl').value);
}

// Search images in Edit modal
function searchEditImages() {
    const searchTerm = document.getElementById('editImageSearch').value.toLowerCase();
    
    if (!searchTerm) {
        renderImageGrid(availableImages, 'editImageGallery', document.getElementById('editSelectedImageUrl').value);
        return;
    }
    
    const filteredImages = availableImages.filter(img => 
        img.name.toLowerCase().includes(searchTerm)
    );
    
    renderImageGrid(filteredImages, 'editImageGallery', document.getElementById('editSelectedImageUrl').value);
}

// Refresh image gallery in Add modal
async function refreshAddImageGallery() {
    availableImages = await loadDishImagesFromStorage();
    renderImageGrid(availableImages, 'addImageGallery', document.getElementById('addSelectedImageUrl').value);
    alert('Image gallery refreshed!');
}

// Refresh image gallery in Edit modal
async function refreshEditImageGallery() {
    availableImages = await loadDishImagesFromStorage();
    renderImageGrid(availableImages, 'editImageGallery', document.getElementById('editSelectedImageUrl').value);
    alert('Image gallery refreshed!');
}

// Upload image to Supabase Storage
async function uploadImageToStorage(file) {
    try {
        // Create unique filename
        const fileExt = file.name.split('.').pop();
        const fileName = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${fileExt}`;
        const filePath = fileName;
        
        // Upload to Supabase Storage
        const { data, error } = await supabaseClient.storage
            .from('dish-images')
            .upload(filePath, file, {
                cacheControl: '3600',
                upsert: false
            });
        
        if (error) {
            console.error('Error uploading image:', error);
            return null;
        }
        
        // Get public URL
        const { data: { publicUrl } } = supabaseClient.storage
            .from('dish-images')
            .getPublicUrl(filePath);
        
        console.log('Image uploaded successfully:', publicUrl);
        return publicUrl;
        
    } catch (error) {
        console.error('Error uploading image:', error);
        return null;
    }
}

// Handle staff access
async function handleStaffAccess(user, restaurantSlug) {
    try {
        // Get restaurant by slug
        const { data: restaurant, error: resError } = await supabaseClient
            .from('restaurants')
            .select('*')
            .eq('url_slug', restaurantSlug)
            .single();
        
        if (resError || !restaurant) {
            alert('Restaurant not found. Redirecting...');
            window.location.href = `../menu-dynamic.html?slug=${restaurantSlug}`;
            return;
        }
        
        // Check if user is super admin
        if (user.email === 'admin@royalkitchen.com') {
            console.log('✓ Super admin accessing restaurant:', restaurant.name);
            
            currentUser = {
                user_id: user.id,
                email: user.email,
                name: 'Super Admin',
                role: 'admin',
                permissions: {
                    "addDish": true,
                    "editDish": true,
                    "deleteDish": true,
                    "manageStaff": true,
                    "viewRevenue": true,
                    "reserveTable": true,
                    "viewTableOrders": true,
                    "manageRestaurants": true,
                    "manageSubscriptions": true,
                    "viewAllData": true
                }
            };
            currentRestaurant = restaurant;
            userRole = 'admin';
            
            setupStaffUI();
            await loadRestaurantData(restaurant.id);
            document.getElementById('adminLoginModal').classList.add('hidden');
            document.getElementById('adminDashboard').classList.remove('hidden');
            return;
        }
        
        // Check if user is staff for this restaurant
        const { data: staffUser, error: staffError } = await supabaseClient
            .from('staff_users')
            .select('*')
            .eq('user_id', user.id)
            .eq('restaurant_id', restaurant.id)
            .eq('is_active', true)
            .single();
        
        if (staffError || !staffUser) {
            alert('You are not authorized to access this restaurant dashboard.');
            window.location.href = `../menu-dynamic.html?slug=${restaurantSlug}`;
            return;
        }
        
        currentUser = staffUser;
        currentRestaurant = restaurant;
        userRole = staffUser.role;
        
        // Set default permissions if none exist
        if (!staffUser.permissions || Object.keys(staffUser.permissions).length === 0) {
            await setDefaultPermissions(staffUser.id, staffUser.role);
            const { data: updatedUser } = await supabaseClient
                .from('staff_users')
                .select('*')
                .eq('id', staffUser.id)
                .single();
            currentUser = updatedUser;
        }
        
        setupStaffUI();
        await loadRestaurantData(restaurant.id);
        document.getElementById('adminLoginModal').classList.add('hidden');
        document.getElementById('adminDashboard').classList.remove('hidden');
        
    } catch (error) {
        console.error('Staff access error:', error);
        document.getElementById('adminLoginModal').classList.remove('hidden');
    }
}

// Set default permissions
async function setDefaultPermissions(userId, role) {
    const defaultPermissions = {
        'owner': {
            "addDish": true,
            "editDish": true,
            "deleteDish": true,
            "manageStaff": true,
            "viewRevenue": true,
            "reserveTable": true,
            "viewTableOrders": true
        },
        'manager': {
            "addDish": true,
            "editDish": true,
            "deleteDish": true,
            "manageStaff": false,
            "viewRevenue": true,
            "reserveTable": true,
            "viewTableOrders": true
        },
        'chef': {
            "addDish": true,
            "editDish": true,
            "deleteDish": true,
            "manageStaff": false,
            "viewRevenue": false,
            "reserveTable": false,
            "viewTableOrders": true
        },
        'waiter': {
            "addDish": false,
            "editDish": false,
            "deleteDish": false,
            "manageStaff": false,
            "viewRevenue": false,
            "reserveTable": true,
            "viewTableOrders": true
        }
    };
    
    const permissions = defaultPermissions[role] || defaultPermissions.waiter;
    
    const { error } = await supabaseClient
        .from('staff_users')
        .update({ 
            permissions: permissions,
            updated_at: new Date().toISOString()
        })
        .eq('id', userId);
    
    if (error) {
        console.error('Error setting permissions:', error);
        throw error;
    }
}

// Check permissions
function hasPermission(permissionName) {
    // Super admin has all permissions
    if (currentUser?.email === 'admin@royalkitchen.com') return true;
    
    // Regular admin has all permissions
    if (userRole === 'admin') return true;
    
    // Check staff user permissions
    const permissions = currentUser?.permissions || {};
    return permissions[permissionName] === true;
}

// Update UI based on permissions
function updateUIBasedOnPermissions() {
    if (userRole === 'admin') return;
    
    const staffActionsSection = document.getElementById('staffActionsSection');
    if (staffActionsSection) {
        staffActionsSection.classList.remove('hidden');
    }
    
    document.querySelectorAll('[data-permission]').forEach(element => {
        const permissionName = element.getAttribute('data-permission');
        const hasPerm = hasPermission(permissionName);
        
        if (hasPerm) {
            element.classList.remove('hidden');
        } else {
            element.classList.add('hidden');
        }
        
        if (element.tagName === 'BUTTON') {
            element.disabled = !hasPerm;
        }
    });
}

// Add Dish Modal
async function showAddDishModal() {
    if (!hasPermission('addDish')) {
        alert('You do not have permission to add dishes');
        return;
    }
    
    // Reset form
    document.getElementById('addDishForm').reset();
    
    // Clear image selection
    document.getElementById('addSelectedImageUrl').value = '';
    document.getElementById('addSelectedImagePreview').src = 'https://via.placeholder.com/300x200?text=No+Image';
    document.getElementById('addImageSearch').value = '';
    
    // Load and display images from Supabase
    availableImages = await loadDishImagesFromStorage();
    renderImageGrid(availableImages, 'addImageGallery', null);
    
    // Show modal
    document.getElementById('addDishModal').classList.remove('hidden');
}

function closeAddDishModal() {
    document.getElementById('addDishModal').classList.add('hidden');
    document.getElementById('addSelectedImageUrl').value = '';
    document.getElementById('addSelectedImagePreview').src = 'https://via.placeholder.com/300x200?text=No+Image';
}

async function saveNewDish() {
    if (!hasPermission('addDish')) {
        alert('Permission denied');
        return;
    }
    
    // Validate required fields
    const dishName = document.getElementById('dishName').value;
    const dishPrice = document.getElementById('dishPrice').value;
    const dishCategory = document.getElementById('dishCategory').value;
    
    if (!dishName || !dishPrice || !dishCategory) {
        alert('Please fill in all required fields (Name, Price, Category)');
        return;
    }
    
    // Show loading state
    const saveBtn = document.getElementById('saveDishBtn');
    const loading = document.getElementById('saveDishLoading');
    saveBtn.disabled = true;
    loading.classList.remove('hidden');
    
    try {
        // Get selected image URL
        const finalImageUrl = document.getElementById('addSelectedImageUrl').value || null;
        
        // Prepare dish data
        const dishData = {
            restaurant_id: currentRestaurant.id,
            name: dishName,
            description: document.getElementById('dishDescription').value,
            category: dishCategory,
            price: parseFloat(dishPrice),
            preparation_time: parseInt(document.getElementById('dishPrepTime').value) || null,
            is_available: document.getElementById('dishAvailability').value === 'true',
            tags: document.getElementById('dishTags').value.split(',').map(tag => tag.trim()).filter(tag => tag),
            image_url: finalImageUrl,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        };
        
        // Save to database
        const { data, error } = await supabaseClient
            .from('dishes')
            .insert([dishData])
            .select();
        
        if (error) {
            console.error('Database error:', error);
            throw error;
        }
        
        // Refresh dishes list
        await loadRestaurantData(currentRestaurant.id);
        
        // Show success message
        alert('Dish added successfully!');
        closeAddDishModal();
        
        // Update UI if restaurants view is open
        if (!document.getElementById('viewRestaurants').classList.contains('hidden')) {
            loadRestaurantsTable();
        }
        
    } catch (error) {
        console.error('Error adding dish:', error);
        alert('Error adding dish: ' + (error.message || 'Unknown error'));
    } finally {
        // Reset loading state
        saveBtn.disabled = false;
        loading.classList.add('hidden');
    }
}

// Edit Dish Modal
async function showEditDishModal() {
    if (!hasPermission('editDish')) {
        alert('You do not have permission to edit dishes');
        return;
    }
    
    if (dishes.length === 0) {
        alert('No dishes available to edit');
        return;
    }
    
    // For demo, use first dish - in real app, you'd select which dish to edit
    const dish = dishes[0];
    
    // Fill form with dish data
    document.getElementById('editDishId').value = dish.id;
    document.getElementById('editDishName').value = dish.name;
    document.getElementById('editDishDescription').value = dish.description || '';
    document.getElementById('editDishCategory').value = dish.category;
    document.getElementById('editDishPrice').value = dish.price;
    document.getElementById('editDishPrepTime').value = dish.preparation_time || '';
    document.getElementById('editDishAvailability').value = dish.is_available ? 'true' : 'false';
    document.getElementById('editDishTags').value = dish.tags ? dish.tags.join(', ') : '';
    
    // Set selected image
    const currentImageUrl = dish.image_url || '';
    document.getElementById('editSelectedImageUrl').value = currentImageUrl;
    document.getElementById('editSelectedImagePreview').src = currentImageUrl || 'https://via.placeholder.com/300x200?text=No+Image';
    document.getElementById('editImageSearch').value = '';
    
    // Load and display images from Supabase
    availableImages = await loadDishImagesFromStorage();
    renderImageGrid(availableImages, 'editImageGallery', currentImageUrl);
    
    // Show modal
    document.getElementById('editDishModal').classList.remove('hidden');
}

function closeEditDishModal() {
    document.getElementById('editDishModal').classList.add('hidden');
    document.getElementById('editSelectedImageUrl').value = '';
    document.getElementById('editSelectedImagePreview').src = 'https://via.placeholder.com/300x200?text=No+Image';
}

async function updateDish() {
    if (!hasPermission('editDish')) {
        alert('Permission denied');
        return;
    }
    
    const dishId = document.getElementById('editDishId').value;
    
    // Validate required fields
    if (!dishId || !document.getElementById('editDishName').value || 
        !document.getElementById('editDishPrice').value || 
        !document.getElementById('editDishCategory').value) {
        alert('Please fill in all required fields');
        return;
    }
    
    // Show loading state
    const updateBtn = document.getElementById('updateDishBtn');
    const loading = document.getElementById('updateDishLoading');
    updateBtn.disabled = true;
    loading.classList.remove('hidden');
    
    try {
        // Get selected image URL
        const finalImageUrl = document.getElementById('editSelectedImageUrl').value || null;
        
        // Prepare dish data
        const dishData = {
            name: document.getElementById('editDishName').value,
            description: document.getElementById('editDishDescription').value,
            category: document.getElementById('editDishCategory').value,
            price: parseFloat(document.getElementById('editDishPrice').value),
            preparation_time: parseInt(document.getElementById('editDishPrepTime').value) || null,
            is_available: document.getElementById('editDishAvailability').value === 'true',
            tags: document.getElementById('editDishTags').value.split(',').map(tag => tag.trim()).filter(tag => tag),
            image_url: finalImageUrl,
            updated_at: new Date().toISOString()
        };
        
        // Update in database
        const { data, error } = await supabaseClient
            .from('dishes')
            .update(dishData)
            .eq('id', dishId)
            .select();
        
        if (error) {
            console.error('Database error:', error);
            throw error;
        }
        
        // Refresh dishes list
        await loadRestaurantData(currentRestaurant.id);
        
        // Show success message
        alert('Dish updated successfully!');
        closeEditDishModal();
        
        // Update UI if restaurants view is open
        if (!document.getElementById('viewRestaurants').classList.contains('hidden')) {
            loadRestaurantsTable();
        }
        
    } catch (error) {
        console.error('Error updating dish:', error);
        alert('Error updating dish: ' + (error.message || 'Unknown error'));
    } finally {
        // Reset loading state
        updateBtn.disabled = false;
        loading.classList.add('hidden');
    }
}

// Delete Dish
function showDeleteDishModal() {
    if (!hasPermission('deleteDish')) {
        alert('You do not have permission to delete dishes');
        return;
    }
    
    if (dishes.length === 0) {
        alert('No dishes available to delete');
        return;
    }
    
    const dish = dishes[0];
    document.getElementById('deleteDishId').value = dish.id;
    document.getElementById('deleteDishMessage').textContent = `Are you sure you want to delete "${dish.name}"? This action cannot be undone.`;
    
    document.getElementById('deleteDishModal').classList.remove('hidden');
}

function closeDeleteDishModal() {
    document.getElementById('deleteDishModal').classList.add('hidden');
}

async function confirmDeleteDish() {
    if (!hasPermission('deleteDish')) {
        alert('Permission denied');
        return;
    }
    
    const dishId = document.getElementById('deleteDishId').value;
    
    try {
        const { data, error } = await supabaseClient
            .from('dishes')
            .delete()
            .eq('id', dishId);
        
        if (error) throw error;
        
        // Refresh dishes list
        await loadRestaurantData(currentRestaurant.id);
        
        // Show success message
        alert('Dish deleted successfully!');
        closeDeleteDishModal();
        
        // Update UI if restaurants view is open
        if (!document.getElementById('viewRestaurants').classList.contains('hidden')) {
            loadRestaurantsTable();
        }
        
    } catch (error) {
        console.error('Error deleting dish:', error);
        alert('Error deleting dish: ' + error.message);
    }
}

// Setup UI for staff
function setupStaffUI() {
    document.querySelectorAll('.admin-only').forEach(el => {
        el.style.display = 'none';
    });
    
    document.querySelectorAll('.staff-only').forEach(el => {
        el.style.display = 'block';
    });
    
    // Show super admin badge if applicable
    if (currentUser?.email === 'admin@royalkitchen.com') {
        document.getElementById('dashboardTitle').innerHTML = (currentRestaurant?.name || 'Staff Dashboard') + ' <span class="text-xs bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-2 py-1 rounded-full ml-2">SUPER ADMIN</span>';
        document.getElementById('dashboardSubtitle').textContent = 'Full Access Mode';
    } else {
        document.getElementById('dashboardTitle').textContent = currentRestaurant?.name || 'Staff Dashboard';
        document.getElementById('dashboardSubtitle').textContent = 'Staff Portal';
    }
    
    document.getElementById('restaurantsViewTitle').textContent = 'Menu Management';
    document.getElementById('restaurantsViewSubtitle').textContent = 'Manage your restaurant menu';
    
    updateUIBasedOnPermissions();
}

// Handle admin access
async function handleAdminAccess(user) {
    try {
        // Check if user is the super admin
        if (user.email === 'admin@royalkitchen.com') {
            console.log('✓ Super admin detected:', user.email);
            
            // Create or get super admin user record
            const { data: existingAdmin, error: checkError } = await supabaseClient
                .from('staff_users')
                .select('*')
                .eq('email', user.email)
                .single();
            
            let adminUser;
            
            if (checkError || !existingAdmin) {
                // Create super admin record if doesn't exist
                const { data: newAdmin, error: createError } = await supabaseClient
                    .from('staff_users')
                    .insert([{
                        user_id: user.id,
                        email: user.email,
                        name: 'Super Admin',
                        role: 'admin',
                        is_active: true,
                        permissions: {
                            "addDish": true,
                            "editDish": true,
                            "deleteDish": true,
                            "manageStaff": true,
                            "viewRevenue": true,
                            "reserveTable": true,
                            "viewTableOrders": true,
                            "manageRestaurants": true,
                            "manageSubscriptions": true,
                            "viewAllData": true
                        },
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    }])
                    .select()
                    .single();
                
                if (createError) {
                    console.error('Error creating super admin:', createError);
                } else {
                    adminUser = newAdmin;
                }
            } else {
                adminUser = existingAdmin;
            }
            
            currentUser = adminUser || {
                email: user.email,
                name: 'Super Admin',
                role: 'admin'
            };
            userRole = 'admin';
            
            setupAdminUI();
            await loadAdminData();
            document.getElementById('adminLoginModal').classList.add('hidden');
            document.getElementById('adminDashboard').classList.remove('hidden');
            return;
        }
        
        // Check if user is a regular admin
        const { data: adminUser, error: adminError } = await supabaseClient
            .from('staff_users')
            .select('*')
            .eq('email', user.email)
            .eq('role', 'admin')
            .single();
            
        if (adminError || !adminUser) {
            // Check if user is a staff member of any restaurant
            const { data: staffUser } = await supabaseClient
                .from('staff_users')
                .select('*, restaurants(*)')
                .eq('user_id', user.id)
                .eq('is_active', true)
                .single();
                
            if (staffUser) {
                window.location.href = `index.html?restaurant=${staffUser.restaurants.url_slug}&staff=true`;
                return;
            }
            
            alert('Access denied. Admin privileges required.');
            await supabaseClient.auth.signOut();
            document.getElementById('adminLoginModal').classList.remove('hidden');
            return;
        }
        
        currentUser = adminUser;
        userRole = 'admin';
        
        setupAdminUI();
        await loadAdminData();
        document.getElementById('adminLoginModal').classList.add('hidden');
        document.getElementById('adminDashboard').classList.remove('hidden');
        
    } catch (error) {
        console.error('Admin access error:', error);
        document.getElementById('adminLoginModal').classList.remove('hidden');
    }
}

// Setup UI for admin
function setupAdminUI() {
    document.querySelectorAll('.admin-only').forEach(el => {
        el.style.display = 'block';
    });
    
    document.querySelectorAll('.staff-only').forEach(el => {
        el.style.display = 'none';
    });
    
    document.getElementById('staffActionsSection').style.display = 'none';
    
    // Show super admin badge if applicable
    if (currentUser?.email === 'admin@royalkitchen.com') {
        document.getElementById('dashboardTitle').innerHTML = 'Admin Panel <span class="text-xs bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-2 py-1 rounded-full ml-2">SUPER ADMIN</span>';
    } else {
        document.getElementById('dashboardTitle').textContent = 'Admin Panel';
    }
    
    document.getElementById('dashboardSubtitle').textContent = 'DigitalMenuPro';
}

// Handle login
async function handleAdminLogin() {
    const email = document.getElementById('adminEmailInput').value;
    const password = document.getElementById('adminPassword').value;
    
    if (!email || !password) {
        alert('Please enter email and password');
        return;
    }
    
    try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({
            email: email,
            password: password
        });
        
        if (error) throw error;
        window.location.reload();
        
    } catch (error) {
        console.error('Admin login error:', error);
        alert('Login failed: ' + error.message);
    }
}

// Logout
async function adminLogout() {
    try {
        await supabaseClient.auth.signOut();
        currentUser = null;
        window.location.reload();
    } catch (error) {
        console.error('Logout error:', error);
    }
}

// Load admin data
async function loadAdminData() {
    try {
        // Load restaurants
        const { data: restaurantsData, error: resError } = await supabaseClient
            .from('restaurants')
            .select('*')
            .order('created_at', { ascending: false });
        
        if (!resError) restaurants = restaurantsData || [];
        
        // Update admin name and email
        document.getElementById('adminName').textContent = currentUser?.name || 'Admin User';
        document.getElementById('adminEmail').textContent = currentUser?.email || 'admin@digitalmenu.com';
        
        updateDashboardStats();
        
    } catch (error) {
        console.error('Error loading admin data:', error);
    }
}

// Load restaurant data for staff dashboard
async function loadRestaurantData(restaurantId) {
    try {
        // Load dishes for this restaurant
        const { data: dishesData, error: dishesError } = await supabaseClient
            .from('dishes')
            .select('*')
            .eq('restaurant_id', restaurantId)
            .order('category', { ascending: true });
        
        if (!dishesError) {
            dishes = dishesData || [];
        } else {
            console.error('Error loading dishes:', dishesError);
            dishes = [];
        }
        
        // Update UI with restaurant name
        document.getElementById('adminName').textContent = currentUser?.name || 'Staff User';
        document.getElementById('adminEmail').textContent = currentUser?.email || currentUser?.user_email || 'staff@example.com';
        
        updateDashboardStats();
        
    } catch (error) {
        console.error('Error loading restaurant data:', error);
        dishes = [];
    }
}

// Update dashboard stats
function updateDashboardStats() {
    // Total restaurants
    document.getElementById('totalRestaurants').textContent = restaurants.length;
    
    // Update title based on user
    if (userRole !== 'admin' && currentRestaurant) {
        document.getElementById('stat1Title').textContent = 'Menu Items';
        document.getElementById('totalRestaurants').textContent = dishes.length;
        
        document.getElementById('stat2Title').textContent = 'Active Staff';
        document.getElementById('activeSubscriptions').textContent = '0';
        
        document.getElementById('stat3Title').textContent = 'Today\'s Orders';
        document.getElementById('monthlyRevenue').textContent = '0';
        
        document.getElementById('stat4Title').textContent = 'Table Occupancy';
        document.getElementById('pendingPayments').textContent = '0%';
    }
}

// View Navigation
function showView(viewName) {
    document.querySelectorAll('.view').forEach(view => {
        view.classList.add('hidden');
    });
    
    document.querySelectorAll('nav a').forEach(navItem => {
        navItem.classList.remove('active-nav', 'bg-gray-700');
    });
    
    const activeNav = document.querySelector(`nav a[onclick="showView('${viewName}')"]`);
    if (activeNav) {
        activeNav.classList.add('active-nav', 'bg-gray-700');
    }
    
    const viewElement = document.getElementById(`view${viewName.charAt(0).toUpperCase() + viewName.slice(1)}`);
    if (viewElement) {
        viewElement.classList.remove('hidden');
    }
    
    updateViewTitle(viewName);
    
    if (viewName === 'restaurants') {
        loadRestaurantsTable();
    }
}

function updateViewTitle(viewName) {
    const titles = {
        'dashboard': { 
            title: userRole === 'admin' ? 'Admin Dashboard' : `${currentRestaurant?.name || 'Restaurant'} Dashboard`, 
            subtitle: userRole === 'admin' ? 'System Overview & Analytics' : 'Real-time Overview & Analytics' 
        },
        'restaurants': { 
            title: userRole === 'admin' ? 'Restaurant Management' : 'Menu Management', 
            subtitle: userRole === 'admin' ? 'Manage all registered restaurants' : 'Manage your restaurant menu items' 
        }
    };
    
    const viewInfo = titles[viewName] || titles.dashboard;
    document.getElementById('viewTitle').textContent = viewInfo.title;
    document.getElementById('viewSubtitle').textContent = viewInfo.subtitle;
}

// Sidebar Toggle
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const toggleBtn = document.querySelector('[onclick="toggleSidebar()"] i');
    
    sidebar.classList.toggle('collapsed');
    
    if (sidebar.classList.contains('collapsed')) {
        mainContent.style.marginLeft = '80px';
        toggleBtn.classList.remove('fa-chevron-left');
        toggleBtn.classList.add('fa-chevron-right');
        document.querySelector('[onclick="toggleSidebar()"] span').textContent = 'Expand Sidebar';
    } else {
        mainContent.style.marginLeft = '256px';
        toggleBtn.classList.remove('fa-chevron-right');
        toggleBtn.classList.add('fa-chevron-left');
        document.querySelector('[onclick="toggleSidebar()"] span').textContent = 'Collapse Sidebar';
    }
}

// Notifications toggle
function toggleNotifications() {
    const panel = document.getElementById('notificationsPanel');
    panel.classList.toggle('hidden');
}

// Load restaurants table
async function loadRestaurantsTable() {
    try {
        if (userRole === 'admin') {
            await loadAdminRestaurantsTable();
        } else {
            await loadStaffMenuTable();
        }
    } catch (error) {
        console.error('Error loading table:', error);
    }
}

// Load admin restaurants table
async function loadAdminRestaurantsTable() {
    document.getElementById('restaurantsTableHeader').innerHTML = `
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Restaurant</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Owner</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Registered</th>
    `;
    
    let tableHTML = '';
    restaurants.forEach(restaurant => {
        tableHTML += `
            <tr class="restaurant-row hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-utensils text-blue-600"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-900">${restaurant.name}</div>
                            <div class="text-sm text-gray-500">${restaurant.url_slug}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${restaurant.owner_name || restaurant.owner_email}</div>
                    <div class="text-sm text-gray-500">${restaurant.owner_email}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="status-badge ${restaurant.status === 'active' ? 'status-active' : restaurant.status === 'pending' ? 'status-pending' : 'status-suspended'}">
                        ${restaurant.status.toUpperCase()}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${new Date(restaurant.created_at).toLocaleDateString()}
                </td>
            </tr>
        `;
    });
    
    document.getElementById('restaurantsTable').innerHTML = tableHTML || `
        <tr>
            <td colspan="4" class="px-6 py-8 text-center text-gray-500">
                No restaurants found
            </td>
        </tr>
    `;
}

// Load staff menu table
async function loadStaffMenuTable() {
    document.getElementById('restaurantsTableHeader').innerHTML = `
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dish</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
    `;
    
    let tableHTML = '';
    dishes.forEach(dish => {
        const statusClass = dish.is_available ? 'status-active' : 'status-suspended';
        const statusText = dish.is_available ? 'Available' : 'Unavailable';
        
        tableHTML += `
            <tr class="dish-row">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 h-10 w-10 bg-gray-100 rounded-lg flex items-center justify-center">
                            ${dish.image_url ? 
                                `<img src="${dish.image_url}" alt="${dish.name}" class="w-full h-full object-cover rounded-lg">` :
                                `<i class="fas fa-utensil-spoon text-gray-600"></i>`
                            }
                        </div>
                        <div class="ml-4">
                            <div class="text-sm font-medium text-gray-900">${dish.name}</div>
                            <div class="text-sm text-gray-500 truncate max-w-xs">${dish.description || 'No description'}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 py-1 text-xs rounded bg-blue-100 text-blue-800">${dish.category || 'Uncategorized'}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                    ₹${dish.price || '0'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="status-badge ${statusClass}">${statusText}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button onclick="editDishRow('${dish.id}')" class="text-green-600 hover:text-green-900 mr-3">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="toggleDishStatus('${dish.id}', ${dish.is_available})" class="${dish.is_available ? 'text-red-600 hover:text-red-900' : 'text-green-600 hover:text-green-900'}">
                        <i class="fas ${dish.is_available ? 'fa-ban' : 'fa-check'}"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    document.getElementById('restaurantsTable').innerHTML = tableHTML || `
        <tr>
            <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                No dishes found
            </td>
        </tr>
    `;
}

// Edit dish from table row
async function editDishRow(dishId) {
    if (!hasPermission('editDish')) {
        alert('You do not have permission to edit dishes');
        return;
    }
    
    const dish = dishes.find(d => d.id === dishId);
    if (!dish) return;
    
    // Fill form with dish data
    document.getElementById('editDishId').value = dish.id;
    document.getElementById('editDishName').value = dish.name;
    document.getElementById('editDishDescription').value = dish.description || '';
    document.getElementById('editDishCategory').value = dish.category;
    document.getElementById('editDishPrice').value = dish.price;
    document.getElementById('editDishPrepTime').value = dish.preparation_time || '';
    document.getElementById('editDishAvailability').value = dish.is_available ? 'true' : 'false';
    document.getElementById('editDishTags').value = dish.tags ? dish.tags.join(', ') : '';
    
    // Set selected image
    const currentImageUrl = dish.image_url || '';
    document.getElementById('editSelectedImageUrl').value = currentImageUrl;
    document.getElementById('editSelectedImagePreview').src = currentImageUrl || 'https://via.placeholder.com/300x200?text=No+Image';
    document.getElementById('editImageSearch').value = '';
    
    // Load and display images from Supabase
    availableImages = await loadDishImagesFromStorage();
    renderImageGrid(availableImages, 'editImageGallery', currentImageUrl);
    
    // Show modal
    document.getElementById('editDishModal').classList.remove('hidden');
}

// Toggle dish status
async function toggleDishStatus(dishId, currentStatus) {
    if (!hasPermission('editDish')) {
        alert('You do not have permission to edit dishes');
        return;
    }
    
    const newStatus = !currentStatus;
    
    try {
        const { data, error } = await supabaseClient
            .from('dishes')
            .update({ 
                is_available: newStatus,
                updated_at: new Date().toISOString()
            })
            .eq('id', dishId)
            .select();
        
        if (error) throw error;
        
        // Refresh dishes list
        await loadRestaurantData(currentRestaurant.id);
        
        // Update UI
        if (!document.getElementById('viewRestaurants').classList.contains('hidden')) {
            loadRestaurantsTable();
        }
        
        alert(`Dish ${newStatus ? 'enabled' : 'disabled'} successfully!`);
        
    } catch (error) {
        console.error('Error toggling dish status:', error);
        alert('Error updating dish status: ' + error.message);
    }
}

// Filter restaurants/menu items
function filterRestaurants() {
    const searchTerm = document.getElementById('restaurantSearch').value.toLowerCase();
    console.log('Filtering by:', searchTerm);
    // Implement actual filtering logic here
}

// Export restaurants (stub function)
function exportRestaurants() {
    alert('Export functionality will be implemented');
}

// Placeholder functions for staff actions
function showRevenueReport() {
    if (!hasPermission('viewRevenue')) {
        alert('You do not have permission to view revenue');
        return;
    }
    alert('Revenue report feature coming soon!');
}

function showReserveTableModal() {
    if (!hasPermission('reserveTable')) {
        alert('You do not have permission to reserve tables');
        return;
    }
    alert('Table reservation feature coming soon!');
}

function showOrdersModal() {
    if (!hasPermission('viewTableOrders')) {
        alert('You do not have permission to view orders');
        return;
    }
    alert('Orders view feature coming soon!');
}

// Initialize the dashboard
initDashboard();
</script>
</body>
</html>
