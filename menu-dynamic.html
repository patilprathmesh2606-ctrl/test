<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Menu</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='15' fill='%234f46e5'/%3E%3Ctext x='50' y='70' font-size='60' font-family='Arial' fill='white' text-anchor='middle' font-weight='bold'%3EM%3C/text%3E%3C/svg%3E">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .restaurant-header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
        }

        .staff-login-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            text-decoration: none;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .staff-login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
        }

        .restaurant-name {
            font-size: 36px;
            font-weight: 800;
            color: #333;
            margin-bottom: 10px;
        }

        .restaurant-info {
            color: #666;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fee;
            color: #c00;
            padding: 20px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        /* Staff Login Modal Styles */
        .staff-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .staff-modal-content {
            background-color: white;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .staff-modal-header {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            padding: 24px;
            text-align: center;
        }

        .staff-modal-header h3 {
            font-size: 22px;
            font-weight: 700;
            color: white;
            margin: 0;
        }

        .staff-modal-body {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 15px;
        }

        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #10b981;
        }

        .staff-login-submit {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .staff-login-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
        }

        .staff-error-message {
            background-color: #fee2e2;
            color: #991b1b;
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .staff-success-message {
            background-color: #d1fae5;
            color: #065f46;
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .category-section {
            margin-bottom: 30px;
        }

        .category-title {
            background: white;
            padding: 15px 25px;
            border-radius: 15px;
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .menu-items {
            display: grid;
            gap: 15px;
        }

        .menu-item {
            background: white;
            border-radius: 15px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .menu-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .item-image {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            object-fit: cover;
            margin-right: 20px;
        }

        .item-details {
            flex: 1;
        }

        .item-name {
            font-size: 20px;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }

        .item-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .item-price {
            font-size: 22px;
            font-weight: 700;
            color: #667eea;
        }

        .no-items {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 15px;
            color: #999;
        }

        .powered-by {
            text-align: center;
            margin-top: 30px;
            color: white;
            font-size: 14px;
        }

        @media (max-width: 600px) {
            .restaurant-name {
                font-size: 28px;
            }

            .menu-item {
                flex-direction: column;
                text-align: center;
            }

            .item-image {
                margin: 0 0 15px 0;
            }

            .staff-login-btn {
                position: relative;
                top: 0;
                right: 0;
                margin: 0 auto 15px auto;
                width: fit-content;
                display: block;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loadingSection" class="loading">
            <div class="spinner"></div>
            <p>Loading menu...</p>
        </div>

        <div id="errorSection" class="error-message" style="display: none;">
            <h2>‚ö†Ô∏è Restaurant Not Found</h2>
            <p id="errorMessage">This menu is not available.</p>
        </div>

        <div id="menuSection" style="display: none;">
            <div class="restaurant-header">
                <!-- Staff Login Button -->
                <button class="staff-login-btn" id="staffLoginBtn">
                    <i class="fas fa-user-tie"></i>
                    Staff Login
                </button>
                
                <h1 class="restaurant-name" id="restaurantName">Loading...</h1>
                <div class="restaurant-info" id="restaurantInfo"></div>
            </div>

            <div id="menuContent"></div>

            <div class="powered-by">
                <p>Powered by MenuPro üçΩÔ∏è</p>
            </div>
        </div>
    </div>

    <!-- Staff Login Modal -->
    <div class="staff-modal" id="staffModal">
        <div class="staff-modal-content">
            <div class="staff-modal-header">
                <h3>Staff Login</h3>
            </div>
            <div class="staff-modal-body">
                <div class="staff-error-message" id="staffErrorMessage"></div>
                <div class="staff-success-message" id="staffSuccessMessage"></div>
                
                <form id="staffLoginForm">
                    <div class="form-group">
                        <label for="staffEmail"><i class="fas fa-envelope"></i> Email Address</label>
                        <input type="email" id="staffEmail" class="form-control" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label for="staffPassword"><i class="fas fa-lock"></i> Password</label>
                        <input type="password" id="staffPassword" class="form-control" placeholder="Enter your password" required>
                    </div>
                    
                    <button type="submit" class="staff-login-submit" id="staffLoginSubmit">
                        <i class="fas fa-sign-in-alt"></i> Login to Dashboard
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Load Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        (function() {
            'use strict';
            
            // Configuration
            const CONFIG = {
                SUPABASE_URL: 'https://aazqyrkklajqscsdfgjl.supabase.co',
                SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFhenF5cmtrbGFqcXNjc2RmZ2psIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NTg4MjUsImV4cCI6MjA4NDMzNDgyNX0.MCmhASRpt_N1gkK7BiVBzp4NT98aCWOWetgtUCoj7Go',
                //DASHBOARD_URL: 'https://patilprathmesh2606-ctrl.github.io/test' // Your dashboard URL
            };

            // Global variables
            let supabaseClient = null;
            let currentRestaurantId = null;
            let currentRestaurantSlug = null;
            
            // Initialize Supabase client
            function initSupabase() {
                try {
                    supabaseClient = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
                    console.log('‚úÖ Supabase initialized');
                    return true;
                } catch (error) {
                    console.error('‚ùå Supabase init error:', error);
                    showError('Failed to initialize database connection');
                    return false;
                }
            }

            // Get URL slug from URL parameter
            function getUrlSlug() {
                const urlParams = new URLSearchParams(window.location.search);
                const slugParam = urlParams.get('slug');
                
                if (slugParam) {
                    console.log('üìç Slug from parameter:', slugParam);
                    return slugParam;
                }
                
                const path = window.location.pathname;
                const parts = path.split('/').filter(p => p && p !== 'index.html' && !p.endsWith('.html'));
                const slug = parts[parts.length - 1];
                console.log('üìç Slug from path:', slug);
                return slug;
            }

            // Show error message
            function showError(message) {
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('errorSection').style.display = 'block';
                document.getElementById('errorMessage').textContent = message;
            }

            // Show staff error
            function showStaffError(message) {
                const errorDiv = document.getElementById('staffErrorMessage');
                const successDiv = document.getElementById('staffSuccessMessage');
                successDiv.style.display = 'none';
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                setTimeout(() => errorDiv.style.display = 'none', 5000);
            }

            // Show staff success
            function showStaffSuccess(message) {
                const errorDiv = document.getElementById('staffErrorMessage');
                const successDiv = document.getElementById('staffSuccessMessage');
                errorDiv.style.display = 'none';
                successDiv.textContent = message;
                successDiv.style.display = 'block';
            }

            // Staff login function
            async function staffLogin(email, password) {
                try {
                    console.log('Attempting staff login for:', email);
                    
                    // Sign in with email and password
                    const { data: authData, error: authError } = await supabaseClient.auth.signInWithPassword({
                        email: email,
                        password: password
                    });

                    if (authError) {
                        console.error('Auth error:', authError);
                        showStaffError('Invalid email or password');
                        return null;
                    }

                    console.log('‚úÖ Auth successful:', authData.user.id);

                    // Check if user is staff for this restaurant
                    const { data: staffData, error: staffError } = await supabaseClient
                        .from('staff_users')
                        .select('*')
                        .eq('user_id', authData.user.id)
                        .eq('restaurant_id', currentRestaurantId)
                        .eq('is_active', true)
                        .maybeSingle();

                    if (staffError) {
                        console.error('Staff check error:', staffError);
                        showStaffError('Database error. Please try again.');
                        return null;
                    }

                    if (!staffData) {
                        console.error('User is not staff for this restaurant');
                        showStaffError('You are not authorized to manage this restaurant.');
                        await supabaseClient.auth.signOut();
                        return null;
                    }

                    console.log('‚úÖ Staff verified:', staffData.role);
                    showStaffSuccess('‚úÖ Login successful! Redirecting to dashboard...');

                    // Store staff session data in localStorage
                    localStorage.setItem('staff_session', JSON.stringify({
                        user_id: authData.user.id,
                        restaurant_id: currentRestaurantId,
                        staff_id: staffData.id,
                        role: staffData.role,
                        name: staffData.name,
                        logged_in: true
                    }));

                    // Redirect to dashboard (you'll need to create this page)
                    /* setTimeout(() => {
                        window.location.href = `${CONFIG.DASHBOARD_URL}/staff-dashboard.html?restaurant=${currentRestaurantSlug}`;
                    }, 1500); */

                    // Redirect to admin dashboard with restaurant context
setTimeout(() => {
    // Get the base URL
    const protocol = window.location.protocol;
    const host = window.location.host;
    const pathname = window.location.pathname;
    
    // Remove the filename from pathname
    const path = pathname.substring(0, pathname.lastIndexOf('/'));
    
    // Construct the redirect URL
    const redirectUrl = `${protocol}//${host}${path}/admin/index.html?restaurant=${currentRestaurantSlug}&staff=true`;
    
    console.log('Redirecting to:', redirectUrl);
    window.location.href = redirectUrl;
}, 1500);

                    return staffData;

                } catch (error) {
                    console.error('Staff login error:', error);
                    showStaffError('Login failed. Please try again.');
                    return null;
                }
            }

            // Fetch restaurant and menu data
            async function loadMenu() {
                const urlSlug = getUrlSlug();
                currentRestaurantSlug = urlSlug;
                
                if (!urlSlug) {
                    showError('No restaurant specified. Please use: ?slug=restaurant-name');
                    return;
                }

                console.log('üîç Loading menu for:', urlSlug);

                try {
                    // Fetch restaurant
                    const { data: restaurant, error: restaurantError } = await supabaseClient
                        .from('restaurants')
                        .select('*')
                        .eq('url_slug', urlSlug)
                        .maybeSingle();

                    if (restaurantError) {
                        console.error('‚ùå Database error:', restaurantError);
                        showError('Database error: ' + restaurantError.message);
                        return;
                    }

                    if (!restaurant) {
                        console.error('‚ùå Restaurant not found:', urlSlug);
                        showError(`Restaurant "${urlSlug}" not found.`);
                        return;
                    }

                    if (restaurant.status !== 'active') {
                        showError('This restaurant is currently inactive.');
                        return;
                    }

                    console.log('‚úÖ Restaurant found:', restaurant.name);
                    currentRestaurantId = restaurant.id;

                    // Fetch dishes
                    const { data: dishes, error: dishesError } = await supabaseClient
                        .from('dishes')
                        .select('*')
                        .eq('restaurant_id', restaurant.id)
                        .eq('is_active', true)
                        .order('category', { ascending: true })
                        .order('name', { ascending: true });

                    if (dishesError) {
                        console.error('‚ö†Ô∏è Error loading dishes:', dishesError);
                        displayMenu(restaurant, []);
                        return;
                    }

                    console.log(`‚úÖ Loaded ${dishes ? dishes.length : 0} dishes`);
                    displayMenu(restaurant, dishes || []);

                } catch (error) {
                    console.error('‚ùå Unexpected error:', error);
                    showError('Error loading menu: ' + error.message);
                }
            }

            // Display menu
            function displayMenu(restaurant, dishes) {
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('menuSection').style.display = 'block';

                // Set restaurant info
                document.getElementById('restaurantName').textContent = restaurant.name;
                
                let infoText = '';
                if (restaurant.type) infoText += restaurant.type;
                if (restaurant.address) infoText += (infoText ? ' ‚Ä¢ ' : '') + restaurant.address;
                if (restaurant.owner_phone) infoText += (infoText ? ' ‚Ä¢ ' : '') + restaurant.owner_phone;
                
                document.getElementById('restaurantInfo').textContent = infoText || 'Digital Menu';

                // Group dishes by category
                const categories = {};
                dishes.forEach(dish => {
                    const category = dish.category || 'Other';
                    if (!categories[category]) {
                        categories[category] = [];
                    }
                    categories[category].push(dish);
                });

                const menuContent = document.getElementById('menuContent');
                menuContent.innerHTML = '';

                if (Object.keys(categories).length === 0) {
                    menuContent.innerHTML = `
                        <div class="no-items">
                            <div style="font-size: 48px; margin-bottom: 10px;">üçΩÔ∏è</div>
                            <h3>Menu Coming Soon</h3>
                            <p>This restaurant is still setting up their menu.</p>
                        </div>
                    `;
                    return;
                }

                // Render categories
                Object.keys(categories).sort().forEach(category => {
                    const categorySection = document.createElement('div');
                    categorySection.className = 'category-section';
                    
                    categorySection.innerHTML = `
                        <div class="category-title">${category}</div>
                        <div class="menu-items">
                            ${categories[category].map(dish => `
                                <div class="menu-item">
                                    ${dish.image_url ? `<img src="${dish.image_url}" alt="${dish.name}" class="item-image" onerror="this.style.display='none'">` : ''}
                                    <div class="item-details">
                                        <div class="item-name">${dish.name}</div>
                                        ${dish.description ? `<div class="item-description">${dish.description}</div>` : ''}
                                    </div>
                                    <div class="item-price">‚Çπ${parseFloat(dish.price).toFixed(2)}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                    menuContent.appendChild(categorySection);
                });
            }

            // Initialize staff login modal functionality
            function initStaffLogin() {
                const staffLoginBtn = document.getElementById('staffLoginBtn');
                const staffModal = document.getElementById('staffModal');
                const staffLoginForm = document.getElementById('staffLoginForm');
                const staffLoginSubmit = document.getElementById('staffLoginSubmit');

                if (!staffLoginBtn) return;

                // Open modal
                staffLoginBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    staffModal.style.display = 'flex';
                });

                // Close modal when clicking outside
                window.addEventListener('click', (e) => {
                    if (e.target === staffModal) {
                        staffModal.style.display = 'none';
                    }
                });

                // Handle form submission
                staffLoginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const email = document.getElementById('staffEmail').value.trim();
                    const password = document.getElementById('staffPassword').value;

                    if (!email || !password) {
                        showStaffError('Please enter both email and password');
                        return;
                    }

                    // Show loading
                    const originalText = staffLoginSubmit.innerHTML;
                    staffLoginSubmit.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
                    staffLoginSubmit.disabled = true;

                    try {
                        await staffLogin(email, password);
                    } finally {
                        staffLoginSubmit.innerHTML = originalText;
                        staffLoginSubmit.disabled = false;
                    }
                });
            }

            // Main initialization
            function init() {
                // Initialize Supabase
                if (!initSupabase()) {
                    return;
                }

                // Load menu
                loadMenu();

                // Initialize staff login
                initStaffLogin();
            }

            // Start when page loads
            window.addEventListener('load', init);
        })();
    </script>
</body>
</html>
